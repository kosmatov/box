---
- name: add dockerâ€™s official GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present
  become: true

- name: add docker repository
  apt_repository:
    repo: deb https://download.docker.com/linux/ubuntu mantic stable
    state: present
    filename: docker
    mode: 0600
  become: true

- name: install docker
  apt:
    state: latest
    name:
      - docker-compose
      - docker-buildx
  become: true

- name: start docker service
  service: name=docker enabled=yes state=started
  become: true

- name: add users to docker group
  user:
    name: "{{ item.name }}"
    groups: docker
    append: yes
  with_items: "{{ users }}"
  become: true
  loop_control:
    label: "{{ item.name }}"

- name: install emulators
  command:
    cmd: docker run --privileged --rm tonistiigi/binfmt --install arm64
  changed_when: false

- name: create docker builder
  command:
    cmd: docker buildx create --use
  changed_when: false

- name: check docker-credential-helpers installed
  command: which docker-credential-pass
  ignore_errors: true
  changed_when: false
  register: docker_helpers_path

- name: build docker-credential-helpers
  command:
    cmd: docker buildx bake "https://github.com/docker/docker-credential-helpers.git"
  ignore_errors: true
  when: docker_helpers_path.rc == 1
  register: docker_build

- name: copy executables
  command:
    cmd: cp bin/build/linux_arm64/docker-credential-pass /usr/local/bin/
  when: docker_helpers_path.rc == 1 and docker_build.rc == 0

- name: clean build artifacts
  command: rm -r bin/
  when: docker_helpers_path.rc == 1 and docker_build.rc == 0

- name: ensure .docker exists
  file:
    path: /home/{{ users.0.name }}.linux/.docker
    state: directory
  tags:
    - lima

- name: copy default config
  copy:
    src: files/config.json
    dest: /home/{{ users.0.name }}.linux/.docker/config.json
    force: no
  become: true
  tags:
    - lima
